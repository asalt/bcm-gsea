---
title: "run.Rmd"
author: "BCM MSPC"
date: '`r Sys.Date()`'
output: html_document
params:
  volcanodir: none
  rankfiledir: none
  species: "Homo sapiens"
  genesets_json: >
    [
      {"category": "H", "subcategory": ""},
      {"category": "C2", "subcategory": "CP:KEGG"},
      {"category": "C2", "subcategory": "CP:REACTOME"},
      {"category": "C5", "subcategory": "GO:MF"},
      {"category": "C5", "subcategory": "GO:BP"},
      {"category": "C5", "subcategory": "GO:CC"}
      /* {"category": "C2", "subcategory": "CP:KEGG"}
      */
    ]

---

# setup

```{r setup, include=TRUE}
library(purrr) # for map()
library(magrittr)
library(ggplot2)
library(fs) # for dir_ls()
library(fgsea)
library(dplyr)
library(msigdbr)
library(stringr)
library(readr)
library(tidyr)
knitr::opts_chunk$set(echo = TRUE)


source("./R/io.R")
source("./R/geneset_utils.R")
source("./R/fgsea.R")
```

```{r, label=test, eval=F}
data <- simulate_preranked_data()
geneset <- .GlobalEnv$get_collection("H", "")
geneset_list <- .GlobalEnv$genesets_df_to_list(geneset)
#named_data = list(data=data)
rankobj <- ranks_dfs_to_lists(list(data))

.res <- rankobj[[1]] %>% run_one(geneset_list)
.name <- .res[1, 'pathway'][[1]]

enplot_data <- plotEnrichmentData(geneset_list[[.name]], rankobj[[1]])

.rnkorder <- -rankobj[[1]] %>% (rank)
rankobj[[1]]['rank'] <- .rnkorder

```




```{r, label='load params'}

genesets_of_interest <- jsonlite::parse_json(params$genesets_json)
species <- params$species

genesets_of_interest %>% purrr::map(~{print(.x$category); print(.x$subcategory)})

#SPECIES <- "Homo sapiens" # or "Mus musculus" or Saccharomyces cerevisiae, and others
#params$species
```

# load gene sets

```{r, label='get genesets'}
list_of_geneset_dfs <- genesets_of_interest %>% .GlobalEnv$get_collections()
```

```{r, label='convert geneset objects'}
pathways_list_of_lists <-
  list_of_geneset_dfs %>% purrr::map(.GlobalEnv$genesets_df_to_list)
```

```{r}
# results_list <- .GlobalEnv$run_all_pathways(pathways_list_of_lists, ranks_list)
#pathways_list_of_lists %>% purrr::pluck(1) %>% str %>% head()
```




```{r, eval=F, include=F}
msigdbr::msigdbr_species()
```
```{r, eval=F, include=F}

msigdbr::msigdbr_collections()
```

```{r}
( params )
```
# load

```{r, label='load'}

if ( (!file.exists(params$volcanodir)) &
     (!file.exists(params$rankfiledir))
){
  print("no files present")
  knitr::knit_exit()
}

```


# prepare ranks

```{r, label='prepare ranks'}

rankfiledir <- params$rankfiledir
if ( length(fs::dir_ls(rankfiledir, fail=F))==0 ){
  #print('yes')
  rnkdfs <- .GlobalEnv$create_rnkfiles(params$volcanodir)
  rnkdfs %>% .GlobalEnv$write_rnkfiles(dir = rankfiledir)
} else{

  ( rnkfiles <- dir_ls(rankfiledir, pattern = ".rnk$", fail=F) )
  rnkdfs <- rnkfiles %>% .GlobalEnv$load_rnkfiles()
  #print('no')
}

ranks_list <- rnkdfs %>% .GlobalEnv$ranks_dfs_to_lists()
ranks_list <- rnkdfs %>% map(
  ~ with(.x, setNames(signedlogp, geneid))
)

# rnkdfs %>% str()
```

# run fgsea
```{r, label='run fgsea'}

results_list <- .GlobalEnv$run_all_pathways(pathways_list_of_lists, ranks_list)

(results_list)
```